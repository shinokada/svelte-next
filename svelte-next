#!/usr/bin/env bash

# Title:         svelte-next
# Description:   This script update Svelte version
# Author:        @shinokada
# Date:          2024-05-01
# Update:        2026-02-27

set -eu
VERSION="0.6.0"
SCRIPT_NAME=$(basename "$0")

# Locate the directory that contains lib/ and src/ by trying candidate
# locations in priority order. This works correctly under every install
# method (direct run, awesome, Homebrew libexec, deb/rpm) without any
# hardcoded overrides or symlink resolution tricks.
_find_script_dir() {
    local candidates=(
        # 1. Homebrew: set explicitly by the wrapper in the formula
        "${SVELTE_NEXT_LIBEXEC:-}"
        # 2. Direct run or awesome: support files sit next to the script itself
        "$(cd -- "$(dirname -- "$0")" && pwd)"
        # 3. deb/rpm: nfpm installs support files here
        "/usr/share/svelte-next"
        # 4. Fallback for manual installs that copy only the binary to /usr/local/bin
        "/usr/local/share/svelte-next"
    )
    local dir
    for dir in "${candidates[@]}"; do
        if [[ -n "$dir" && -f "$dir/lib/getoptions.sh" ]]; then
            printf '%s' "$dir"
            return 0
        fi
    done
    printf 'Error: cannot locate svelte-next support files.\n' >&2
    printf 'Looked in:\n' >&2
    for dir in "${candidates[@]}"; do
        [[ -n "$dir" ]] && printf '  %s\n' "$dir" >&2
    done
    exit 1
}

script_dir=$(_find_script_dir)

# Import files
# shellcheck disable=SC1091
{
    . "${script_dir}/lib/getoptions.sh"
    . "${script_dir}/lib/main_definition.sh"
    . "${script_dir}/lib/utils.sh"
    . "${script_dir}/lib/svelte_definition.sh"
    # . "${script_dir}/lib/cmd2_definition.sh"
}

# Keep it. You need this for main parser.
eval "$(getoptions parser_definition parse "$0") exit 1"
parse "$@"
eval "set -- $REST"

# CHECK ENVIRONMENT
# If you need to check OS uncomment this
# if [ "$(uname)" = "Linux" ]; then
#     echo "Your OS is Linux."
# elif [ "$(uname)" = "Darwin" ]; then
#     echo "Your OS is mac."
# fi

# If you are using Bash, check Bash version
# check_bash 5

# Check dependencies always required regardless of package manager
check_cmd git
check_cmd jq

# Add more commands.
# Don't forget to add your command in lib/main_definition.sh
if [ $# -gt 0 ]; then
    cmd=$1
    shift
    case $cmd in
    update)
        eval "$(getoptions parser_definition_svelte parse "$0")"
        parse "$@"
        eval "set -- $REST"
        # shellcheck disable=SC1091
        . "${script_dir}/src/update.sh"
        fn_update "$@"
        ;;
    --) ;; # no subcommand, arguments only
    esac
fi
